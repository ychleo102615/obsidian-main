---
tags: []
date: 2025-06-29
time: 20:56
---
題目：在資料庫實作中，為什麼需要使用多階段提交（two-phase commit, 2PC）來保證分散式交易的一致性？請簡要說明其流程與潛在風險。
回答：沒有多階段提交的話，需要立即取得一致性的交易會容易遇到部分節點對象提交失敗，部分對象提交成功，喪失一致性。透過先確認所有節點已經準備好接受提交之後再執行的話，即使有節點失效，該節點回復時也能夠同步狀態。而風險則是需要花很多時間，如果在確認接受提交的階段就有節點遲遲不回應的話，系統就有可能停滯在那。

你已經抓住了 2PC 的核心動機——避免「部分成功、部分失敗」導致的不一致，還指出了因等待回應可能造成的停滯風險。以下用更有條理的方式補充流程與風險細節：

---

## Two-Phase Commit（2PC）流程

1. **第一階段：Prepare（準備階段）**
    
    - **Coordinator** 向所有 **Participant** 發送 `PREPARE` 請求。
        
    - 每個 Participant 收到後，先在本地做**本地事務**的所有變更（寫入 undo log/redo log），但**不提交**，並回報 `YES`（可提交）或 `NO`（拒絕）。
        
2. **第二階段：Commit or Rollback（提交／回滾）**
    
    - 如果所有 Participant 都回 `YES`，Coordinator 發出 `COMMIT` 指令，所有 Participant 真正提交並釋放鎖，最終達成一致。
        
    - 若有任何一個回 `NO`，Coordinator 發出 `ROLLBACK`，所有 Participant 回滾本地變更，系統恢復到事務前狀態。
        

---

## 保障方式

- **原子一致性**：要麼所有節點都 commit，要麼都 rollback，杜絕「部分成功」的狀況。
    
- **持久日誌**：在 `PREPARE` 階段，各 Participant 將決策（準備好或拒絕）寫入本地日誌，即使節點崩潰重啟，也能依照日誌決定最終要 commit 還是回滾。
    

---

## 潛在風險與限制

1. **阻塞（Blocking）**
    
    - 若在 **Prepare** 階段，某些 Participant 因故障或網路問題未回應，Coordinator 無法進入第二階段，也就無法釋放所有鎖，導致系統資源被長時間鎖住。
        
2. **單點故障**
    
    - Coordinator 若在 `COMMIT` 之前崩潰，各 Participant 雖然都在「準備好」狀態，卻不知該 `COMMIT` 還是 `ROLLBACK`，必須等 Coordinator 重新上線或人工介入才能決定。
        
3. **性能開銷**
    
    - 每次分散式交易都要多做一次網路往返，以及本地寫日誌的 I/O，整體延遲和吞吐都會受限。
        
4. **可擴充性**
    
    - 參與者數量越多，整個協調過程越複雜，失敗機率與阻塞風險也跟著增加。
        

---

**小結**：  
2PC 以兩階段的 prepare/commit 流程，結合本地日誌，確保跨多節點的事務要麼全成功、要麼全失敗，維護分散式一致性。但它也帶來了阻塞與單點瓶頸的風險，並影響整體性能與可擴展性。


[[9. Consistency and Consensus#Atomic Commit and Two-Phase Commit (2PC)]]