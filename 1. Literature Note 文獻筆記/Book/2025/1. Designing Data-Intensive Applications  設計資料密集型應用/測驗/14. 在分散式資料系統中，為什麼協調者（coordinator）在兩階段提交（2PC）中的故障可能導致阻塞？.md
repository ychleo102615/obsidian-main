---
tags: []
date: 2025-07-02
time: 22:38
---
題目：在分散式資料系統中，為什麼協調者（coordinator）在兩階段提交（2PC）中的故障可能導致阻塞？有哪些改良協議被提出來解決這個問題？ 
回答：協調者故障時，其他已經確認過的節點都會處在等待協調者確認所有節點已確認的狀態，並且無法自主離開。我不知道有哪些解決方案

當 Coordinator 在 2PC 的第二階段（Commit／Rollback）故障時，所有已回覆 `YES` 的 Participant 都不知道最終該 Commit 還是 Rollback，只能持續等待 Coordinator 重啟或人工干預，造成整個系統無法釋放鎖、事務長時間阻塞。

為了解決這個「阻塞」問題，DDIA 中提到了幾種改良協議：

1. **三階段提交（Three-Phase Commit, 3PC）**
    
    - 在 2PC 之前多加了一個「CanCommit」→「PreCommit」→「DoCommit」三個階段：
        
        1. **CanCommit**：Coordinator 詢問是否可提交（類似 2PC 的 Prepare）。
            
        2. **PreCommit**：所有 Participant 回 `YES` 後，Coordinator 廣播一個「PreCommit」命令，告訴大家不要回滾，也不要立即提交，只做本地標記。
            
        3. **DoCommit**：再次向所有 Participant 下達真正提交指令。
            
    - **優點**：在 PreCommit 階段，Participant 已知最終一定會 Commit，不用一直等；若 Coordinator 崩潰，可由其他節點接手完成第三階段，避免長時間阻塞。
        
    - **缺點**：需要更多消息往返，且仍不能在所有失敗場景（如網路分割）下完全保證無阻塞。
        
2. **Paxos Commit**
    
    - 把事務提交當成一個 Paxos 共識問題，讓多個節點共同「選舉」出 Commit 或 Abort 的結果：
        
        - 每個 Participant 都可擔任提案者與接受者角色，提交決策可在半數以上節點達成一致後自動完成。
            
    - **優點**：即使 Coordinator（提案者）故障，Paxos 本身的容錯機制仍能在其他節點之間繼續推進共識，不會阻塞。
        
    - **缺點**：實作複雜度高，性能開銷也比 2PC／3PC 大。
        
3. **Presumed Abort／Presumed Commit**
    
    - 這兩種變體並不解決 Coordinator 故障阻塞本質，而是優化了日誌記錄與網路通信：
        
        - **Presumed Abort**：預設事務會 Abort，減少成功事務的日誌寫入。
            
        - **Presumed Commit**：預設事務會 Commit，減少失敗事務的日誌寫入。
            
    - **作用**：降低常態下的 I/O 負擔，但若 Coordinator 故障，Participant 依然要等它或人工干預才能最終決策。
        

---

**小結**：

- **阻塞的根本原因**：Coordinator 崩潰後，Participant 無法自行決定 Commit 還是 Abort，只能持續鎖住資源等回應。
    
- **解決思路**：引入額外階段（3PC）或以共識演算法（Paxos Commit）取代單點 Coordinator，使系統在 Coordinator 故障時仍有機制自動完成決策，避免長時間阻塞。