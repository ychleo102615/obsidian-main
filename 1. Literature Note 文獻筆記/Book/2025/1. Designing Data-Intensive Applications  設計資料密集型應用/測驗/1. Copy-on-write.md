---
tags: []
date: 2025-06-08
time: 21:10
---
# 什麼是寫時複製（copy-on-write）策略？它如何改善資料一致性與效能？」

#### 我的錯誤回答
當資料被寫入leader時，同時更新到其他follower replica
##### 這其實是講資料庫或分散式系統的同步複製（replication）策略


### 解答
#### 1. **原理**：
- 當系統要修改一個資料區塊（比如檔案中的一頁 page、記憶體中的一塊 buffer）時，先將該區塊「複製」到一個新位置，然後只對新位置的複本做寫入操作，舊位置保持不變。
#### 2. **如何改善資料一致性**：
- **原子性（Atomicity）**：讀者要麼看到完整的舊版，要麼看到完整的新版，不會讀到半寫入的髒資料。
- **快照支援**：可以輕鬆生成某個時間點的「快照」，因為舊版本的頁面永遠不會被覆寫。
#### 3. **如何提升效能**：
- **無鎖讀取**：讀者在讀舊版資料時，不需要跟寫者競爭鎖，降低鎖等待與阻塞。
- **順序寫入優化**：可將多次小變更累積後，一次性寫回，有利於 SSD 或磁碟的寫入效能。
#### 4. **應用範例**：
    - 檔案系統如 ZFS、Btrfs
    - 資料庫或儲存引擎中的頁面管理（例如 InnoDB 的 MVCC 實作）
    - LSM-Tree 結構下的物件儲存與快照


### 出現章節
1. **首次出場**：第 3 章講儲存引擎／檔案系統裡的快照與原子性設計時。 B-tree optimizations p.82
2. **再度應用**：第 7 章講交易隔離（尤其是快照隔離、MVCC）時，把它當成底層實作機制之一。[[7. Transactions#Indexes and snapshot isolation]]


COW 的核心思想是「延後複製，直到有真正的寫入需求」，以此最大化資源共用並減少不必要的拷貝工作。除了 B-樹節點結構外，幾乎在所有需要平衡讀寫效能、實現快照或版本控制的系統中，都能看到寫時複製的身影。