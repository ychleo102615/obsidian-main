---
tags: []
date: 2025-08-25
time: 22:34
link: https://github.com/Admol/SystemDesign/blob/main/CHAPTER%2015：DESIGN%20GOOGLE%20DRIVE.md
---
在本章中，我们重点关注以下功能：

- 添加文件。添加文件的最简单方法是将文件拖放到 Google Drive 中。
- 下载文件。
- 跨多个设备同步文件。将文件添加到一台设备后，它会自动同步到其他设备。
- 查看文件修订内容。
- 与您的朋友、家人和同事共享文件
- 当文件被编辑、删除或与您共享时发送通知。

#### 粗略估算


- 假设该应用程序有 5000 万注册用户和 1000 万 DAU。
- 用户获得10 GB 的可用空间。
- 假设用户每天上传2 个文件。平均文件大小为 500 KB。
- 1:1 的读写比。
- 分配的总空间： 5000万×10GB=500PB
- 上传 API 的 QPS： 1000万×2次上传/24小时/3600秒≈240
- 峰值 QPS : QPS×2=480



## 我們先從簡單的事情開始

让我们从下面列出的单个服务器设置开始：

- 一个用于上传和下载文件的 Web 服务器。
- 一个数据库，用于跟踪元数据，如用户数据、登录信息、文件信息等。
- 一个存储系统来存储文件。我们分配了1TB的存储空间来存储文件。

我们花了几个小时设置了一个 Apache 网络服务器、一个 MySQL 数据库和一个名为 `drive/` 的目录作为根目录来存储上传的文件。在 `drive/` 目录下，有一个目录列表，称为名称空间。每个命名空间都包含该用户的所有上传文件。服务器上的文件名与原始文件名保持一致。通过加入命名空间和相对路径，可以唯一标识每个文件或文件夹。

![500](https://github.com/Admol/SystemDesign/raw/main/images/chapter15/figure15-3.png)


### API
#### 上傳
- 單純的小檔案上傳
- 可中斷、恢復的大檔案上傳

可恢复上传 API 的示例： `https://api.example.com/files/upload?uploadType=resumable`
参数：
- `uploadType=resumable`
- `data`: 待上传的本地文件

可恢复上传通过以下 3 个步骤实现：
- 发送初始请求以检索可恢复 URL。
- 上传数据并监控上传状态。
- 如果上传受到干扰，请继续上传。

#### 下載

示例 API：`https://api.example.com/files/download`
参数：
- `path`：下载文件路径
示例参数：

```json
{
  "path": "/recipes/soup/best_soup.txt"
}
```

#### 獲取歷史紀錄
示例 API：`https://api.example.com/files/list_revisions`
参数：
- `path`：要获取修订历史记录的文件的路径
- 要返回的最大修订数。

示例参数：
```json
{
  "path": "/recipes/soup/best_soup.txt",
  "limit": 20
}
```

所有 API 都需要用户身份验证并使用 HTTPS。安全套接字层 (SSL) 保护客户端和后端服务器之间的数据传输。

然後空間滿了。

### 基于 `user_id` 的分片
![600](https://github.com/Admol/SystemDesign/raw/main/images/chapter15/figure15-5.png)


许多领先的公司如Netflix和Airbnb都使用Amazon S3进行存储。"亚马逊简单存储服务（Amazon S3）是一种对象存储服务，提供行业领先的可扩展性、数据可用性、安全性和性能"
scalability, availability, security, performance

Amazon S3 支持同区域和跨区域复制。一个地区是指亚马逊网络服务（AWS）拥有数据中心的地理区域。如图15-6所示，数据可以在同区域（左侧）和跨区域（右侧）复制。冗余文件存储在多个区域，以防止数据丢失并确保可用性。存储桶就像文件系统中的文件夹。
![700](https://github.com/Admol/SystemDesign/raw/main/images/chapter15/figure15-6.png)


- 负载均衡器：添加负载均衡器来分配网络流量。负载均衡器确保流量均匀分布，如果 Web 服务器出现故障，它将重新分配流量。
- Web 服务器：添加负载均衡器后，可以根据流量负载轻松添加/删除更多Web 服务器。
- 元数据数据库：将数据库移出服务器以避免单点故障。同时，设置数据复制和分片以满足可用性和可扩展性要求。
- 文件存储：Amazon S3 用于文件存储。为确保可用性和持久性，文件被复制到两个不同的地理区域。

![500](https://github.com/Admol/SystemDesign/raw/main/images/chapter15/figure15-7.png)



#### 同步冲突

对于像 Google Drive 这样的大型存储系统，同步冲突时有发生。当两个用户同时修改同一个文件或文件夹时，就会发生冲突。我们如何解决冲突？这是我们的策略：先处理的版本获胜，后处理的版本接收冲突。图 15-8 显示了同步冲突的示例。

[![800](https://github.com/Admol/SystemDesign/raw/main/images/chapter15/figure15-8.png)](https://github.com/Admol/SystemDesign/blob/main/images/chapter15/figure15-8.png)

![500](https://github.com/Admol/SystemDesign/raw/main/images/chapter15/figure15-9.png)
用戶2可以同時看到最新的版本，和自己上傳沒成功的版本。他可以自行決定要合併或是覆蓋。


### 高层设计

![600](https://github.com/Admol/SystemDesign/raw/main/images/chapter15/figure15-10.png)

##### Block Servers
讓檔案以小塊（）的形式上傳到雲端。每個塊會有hash值，存在metadata database裡。需要用特定順序重組成檔案。

**Cloud storage**：文件被分割成更小的块并存储在云存储中。

**Cold storage**：冷存储是一种为存储非活动数据而设计的计算机系统，意味着文件在很长一段时间内不会被访问。

**API servers**：这些服务器负责**除上传流程以外的几乎所有工作**。API服务器用于用户认证、管理用户资料、更新文件元数据等。

**Metadata database**：它存储用户、文件、块、版本等元数据。请注意，文件存储在云端，元数据数据库仅包含元数据。

**Notification service**：它是一个发布者/订阅者系统，允许在某些事件发生时将数据从通知服务传输到客户端。在我们的具体案例中，通知服务会在其他地方添加/编辑/删除文件时通知相关客户，以便他们可以提取最新的更改。

**Offline backup queue**：如果客户端离线并且无法拉取最新的文件更改，离线备份队列会存储信息，以便在客户端在线时同步更改


## 塊服務器 Block servers

更新大文件的時候，整份上傳很消耗網路帶寬。

- Delta Sync: 只更新被修改到的block。使用sync演算法
- 壓縮

不是将整个文件上传到存储系统，而是只传输修改过的块。


[![500](https://github.com/Admol/SystemDesign/raw/main/images/chapter15/figure15-11.png)](https://github.com/Admol/SystemDesign/blob/main/images/chapter15/figure15-11.png)

- 一个文件被分割成更小的块。
- 每个块都使用压缩算法进行压缩。
- 为了确保安全，每个块在发送到云存储之前都经过加密。
- 块被上传到云存储。

Delta sync 只有修改过的块才会传输到云存储。突出显示的块“块 2”和“块 5”表示已更改的块。使用增量同步，只有这两个块被上传到云存储。

[![500](https://github.com/Admol/SystemDesign/raw/main/images/chapter15/figure15-12.png)](https://github.com/Admol/SystemDesign/blob/main/images/chapter15/figure15-12.png)



## 高一致性需求 High consistency requirement

- 缓存副本和主服务器中的数据是一致的。
- 在数据库写入时使缓存无效，以确保缓存和数据库保持相同的值。

在关系数据库中实现强一致性很容易，因为它维护了 ACID（原子性、一致性、隔离性、持久性）属性 。但是，NoSQL 数据库默认不支持 ACID 属性。 ACID 属性必须以编程方式合并到同步逻辑中。在我们的设计中，我们选择关系数据库，因为 ACID 是原生支持的。

### Metadata database
![700](https://github.com/Admol/SystemDesign/raw/main/images/chapter15/figure15-13.png)

#### 上传流程
![700](https://github.com/Admol/SystemDesign/raw/main/images/chapter15/figure15-14.png)


#### 下载流程
![700](https://github.com/Admol/SystemDesign/raw/main/images/chapter15/figure15-15.png)

## 通知服務 Notification service

选项：
- 長輪詢 long polling
- WebSocket

我们选择了长轮询：
- 通知服务的通信不是双向的。服务器向客户端发送有关文件更改的信息，反之亦然。
- WebSocket 适用于实时双向通信，例如聊天应用程序。对于 Google 云端硬盘，通知发送不频繁，没有突发数据。

## 节省储存空间

- 一模一樣的塊就不要重複上傳了（hash區分）
- 優化策略
	- 版本數量上限
	- 只留下有價值的版本
- 冷存儲。像 Amazon S3 冰川  这样的冷存储比 S3 便宜得多。


#### 故障处理

在一个大规模的系统中可能会出现故障，我们必须采取设计策略来解决这些故障。你的面试官可能有兴趣听听你是如何处理以下系统故障的：

- 负载均衡器故障：如果负载均衡器出现故障，辅助节点将变为活动状态并接收流量。负载均衡器通常**使用心跳相互监控**，心跳是负载均衡器之间发送的周期性信号。如果负载均衡器在一段时间内没有发送心跳，则认为它失败了。
- 块服务器故障：如果块服务器发生故障，其他服务器将接管未完成或挂起的作业。
- 云存储故障：S3 bucket在不同地域多次复制。如果文件在一个区域不可用，可以从不同区域获取它们。
- API服务器故障：是无状态服务。如果 API 服务器发生故障，流量将通过负载均衡器重定向到其他 API 服务器。
- 元数据缓存故障：元数据缓存服务器被多次复制。如果一个节点宕机，您仍然可以访问其他节点以获取数据。我们将启动一个新的缓存服务器来替换发生故障的服务器。
- 元数据数据库故障
    - Master down：如果master宕机，提升其中一个slave充当新的master，并拉起一个新的slave节点。
    - Slave down：如果一个slave down了，可以用另一个slave进行读操作，带上另一台数据库服务器来代替失效的。
- 通知服务失败：每个在线用户与通知服务器保持一个长轮询连接。因此，每个通知服务器都与许多用户相连。根据 2012 年的 Dropbox 谈话 [6]，每台机器打开超过 100 万个连接。如果服务器出现故障，所有长轮询连接都会丢失，因此客户端必须重新连接到不同的服务器。即使一台服务器可以保持许多打开的连接，它也无法立即重新连接所有丢失的连接。重新连接所有丢失的客户端是一个相对缓慢的过程。
- 离线备份队列故障：队列被多次复制。如果一个队列发生故障，该队列的消费者可能需要重新订阅备用队列。